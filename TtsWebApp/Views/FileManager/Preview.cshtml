@{
    ViewData["Title"] = "图片预览";
    var currentPath = ViewBag.CurrentPath as string ?? "";
    var parentPath = ViewBag.ParentPath as string ?? "";
    var images = ViewBag.Images as List<TtsWebApp.Models.FileItem> ?? new List<TtsWebApp.Models.FileItem>();
    var currentIndex = images.FindIndex(img => img.RelativePath == currentPath);
}

<div class="mb-6">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold text-gray-800">图片预览</h1>
        <div class="flex gap-2">
            <a href="@Url.Action("Index", new { path = parentPath })" 
               class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center">
                <span class="material-symbols-outlined mr-2">arrow_back</span>
                返回列表
            </a>
            <a href="@Url.Action("Download", new { path = currentPath })" 
               class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center">
                <span class="material-symbols-outlined mr-2">download</span>
                下载
            </a>
            <button onclick="deleteCurrentImage()" 
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition flex items-center">
                <span class="material-symbols-outlined mr-2">delete</span>
                删除
            </button>
        </div>
    </div>
</div>

<!-- 主图片显示区 -->
<div class="bg-white rounded-lg shadow overflow-hidden mb-6">
    <div id="imageViewer" class="flex items-center justify-center" style="min-height: 600px; background: #f9fafb;">
        <img id="mainImage" 
             src="/@ViewBag.AdminPath/FileManager/Download?path=@currentPath" 
             alt="预览图片"
             class="max-w-full max-h-[600px] object-contain cursor-pointer" />
    </div>
</div>

<!-- 图片信息 -->
@if (currentIndex >= 0 && currentIndex < images.Count)
{
    var currentImage = images[currentIndex];
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-xl font-bold mb-4">文件信息</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <span class="text-gray-600">文件名：</span>
                <span class="font-medium">@currentImage.Name</span>
            </div>
            <div>
                <span class="text-gray-600">文件大小：</span>
                <span class="font-medium">@currentImage.FormattedSize</span>
            </div>
            <div>
                <span class="text-gray-600">修改时间：</span>
                <span class="font-medium">@currentImage.LastModified.ToString("yyyy-MM-dd HH:mm:ss")</span>
            </div>
            <div>
                <span class="text-gray-600">文件类型：</span>
                <span class="font-medium">@currentImage.Extension.ToUpper()</span>
            </div>
        </div>
    </div>
}

<!-- 缩略图导航 -->
@if (images.Count > 1)
{
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">同目录图片 (@images.Count 张)</h2>
        <div class="grid grid-cols-6 gap-4">
            @foreach (var img in images)
            {
                var isActive = img.RelativePath == currentPath;
                <a href="@Url.Action("Preview", new { path = img.RelativePath })" 
                   class="block border-2 @(isActive ? "border-blue-500" : "border-gray-200") rounded-lg overflow-hidden hover:border-blue-400 transition">
                    <img src="/@ViewBag.AdminPath/FileManager/Download?path=@img.RelativePath" 
                         alt="@img.Name"
                         class="w-full h-32 object-cover" />
                    <div class="p-2 text-xs text-center truncate bg-gray-50">
                        @img.Name
                    </div>
                </a>
            }
        </div>
    </div>
}

@section Scripts {
<!-- Viewer.js CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js"></script>

<script>
    const currentPath = '@Html.Raw(currentPath)';
    const parentPath = '@Html.Raw(parentPath)';
    const adminPath = '@ViewBag.AdminPath';

    // 初始化 Viewer.js
    const imageElement = document.getElementById('mainImage');
    const viewer = new Viewer(imageElement, {
        inline: false,
        navbar: false,
        title: true,
        toolbar: {
            zoomIn: 1,
            zoomOut: 1,
            oneToOne: 1,
            reset: 1,
            prev: 0,
            play: 0,
            next: 0,
            rotateLeft: 1,
            rotateRight: 1,
            flipHorizontal: 1,
            flipVertical: 1
        },
        tooltip: true,
        movable: true,
        zoomable: true,
        rotatable: true,
        scalable: true,
        transition: true,
        fullscreen: true,
        keyboard: true
    });

    // 点击图片查看大图
    imageElement.addEventListener('click', function() {
        viewer.show();
    });

    // 键盘导航
    document.addEventListener('keydown', function(e) {
        const images = @Html.Raw(Json.Serialize(images.Select(i => i.RelativePath).ToList()));
        const currentIndex = images.indexOf(currentPath);
        
        if (e.key === 'ArrowLeft' && currentIndex > 0) {
            // 上一张
            window.location.href = `/${adminPath}/FileManager/Preview?path=${encodeURIComponent(images[currentIndex - 1])}`;
        } else if (e.key === 'ArrowRight' && currentIndex < images.length - 1) {
            // 下一张
            window.location.href = `/${adminPath}/FileManager/Preview?path=${encodeURIComponent(images[currentIndex + 1])}`;
        } else if (e.key === 'Escape') {
            // 返回列表
            window.location.href = `/${adminPath}/FileManager/Index?path=${encodeURIComponent(parentPath)}`;
        }
    });

    // 删除当前图片
    async function deleteCurrentImage() {
        if (!confirm('确定要删除这张图片吗？')) {
            return;
        }

        const formData = new FormData();
        formData.append('Path', currentPath);

        // 添加 CSRF token
        const token = document.querySelector('input[name="__RequestVerificationToken"]');
        if (token) {
            formData.append('__RequestVerificationToken', token.value);
        }

        try {
            const response = await fetch(`/${adminPath}/FileManager/Delete`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                // 返回列表
                window.location.href = `/${adminPath}/FileManager/Index?path=${encodeURIComponent(parentPath)}`;
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('删除失败: ' + error.message);
        }
    }
</script>

<!-- CSRF Token (隐藏) -->
<form style="display: none;">
    @Html.AntiForgeryToken()
</form>
}
