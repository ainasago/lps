# Razor 运行时编译配置说明

## 功能说明
已成功启用 ASP.NET Core Razor 运行时编译功能，现在可以在发布后直接修改视图文件（.cshtml），无需重新编译和部署整个应用程序。

## 配置内容

### 1. 已添加的 NuGet 包
- `Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation` (版本 9.0.10)

### 2. Program.cs 配置
```csharp
builder.Services.AddControllersWithViews()
    .AddRazorRuntimeCompilation();
```

### 3. TtsWebApp.csproj 配置
```xml
<PropertyGroup>
  <!-- 启用运行时编译所需的配置 -->
  <PreserveCompilationContext>true</PreserveCompilationContext>
  <MvcRazorCompileOnPublish>false</MvcRazorCompileOnPublish>
  <!-- 禁用默认的Content项，手动控制文件复制 -->
  <EnableDefaultContentItems>false</EnableDefaultContentItems>
</PropertyGroup>

<!-- 手动包含Razor视图文件用于运行时编译 -->
<ItemGroup>
  <None Include="Views\**\*.cshtml">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </None>
  <None Include="Areas\**\Views\**\*.cshtml">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </None>
  <!-- 包含wwwroot下的所有静态文件 -->
  <Content Include="wwwroot\**\*">
    <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
  </Content>
</ItemGroup>
```

## 使用方法

### 发布应用
```bash
dotnet publish -c Release -o publish
```

### 修改视图文件
1. 发布后，所有 .cshtml 文件都会在 `publish/Views` 目录下
2. 直接编辑这些文件即可
3. 保存后刷新浏览器，修改立即生效（首次访问会有轻微延迟）

### 可修改的文件类型
- ✅ 所有 Views 下的 .cshtml 文件
- ✅ Layout 文件（如 _Layout.cshtml）
- ✅ Partial Views（如 _ValidationScriptsPartial.cshtml）
- ✅ _ViewImports.cshtml 和 _ViewStart.cshtml
- ❌ Controller 代码（需要重新编译）
- ❌ Model 类（需要重新编译）

## 注意事项

### 性能影响
- 首次访问修改后的页面会有轻微延迟（约几十到几百毫秒）
- 后续访问会使用缓存，性能接近预编译版本
- 对于高流量网站，建议在低峰期修改视图

### 安全建议
1. 确保 Views 目录的文件权限设置正确
2. 只允许授权用户修改视图文件
3. 定期备份视图文件
4. 考虑使用版本控制跟踪修改

### 生产环境部署
1. 部署时确保 Views 目录及其所有子目录都被复制
2. 验证文件权限允许应用程序读取 .cshtml 文件
3. 首次部署后测试几个页面，确保运行时编译正常工作

## 验证方法

### 测试步骤
1. 发布应用：`dotnet publish -c Release -o publish`
2. 运行发布的应用：`cd publish && dotnet TtsWebApp.dll`
3. 访问任意页面，确认正常显示
4. 修改某个视图文件（如添加一行文本）
5. 刷新浏览器，确认修改生效

### 检查发布目录
```bash
# 检查 Views 目录是否存在
ls publish/Views

# 统计视图文件数量
ls -R publish/Views/*.cshtml | wc -l
```

## 故障排除

### 问题：修改视图后不生效
- 清除浏览器缓存
- 检查文件是否保存成功
- 查看应用日志是否有编译错误

### 问题：应用启动失败
- 检查 Views 目录是否存在
- 确认 Microsoft.AspNetCore.Mvc.Razor.RuntimeCompilation 包已安装
- 查看启动日志获取详细错误信息

### 问题：性能下降明显
- 考虑只在开发/测试环境启用运行时编译
- 生产环境可以使用预编译版本，通过 CI/CD 自动部署

## 回退到预编译模式

如果需要回退到传统的预编译模式：

1. 修改 TtsWebApp.csproj：
```xml
<PropertyGroup>
  <MvcRazorCompileOnPublish>true</MvcRazorCompileOnPublish>
</PropertyGroup>
```

2. 从 Program.cs 移除：
```csharp
.AddRazorRuntimeCompilation()
```

3. 重新发布应用

## 总结

✅ **已完成配置**
- 添加运行时编译 NuGet 包
- 配置 Program.cs 启用运行时编译
- 配置 .csproj 确保视图文件复制到发布目录
- 测试验证发布后可以修改视图

✅ **支持的修改**
- 所有 Razor 视图文件（.cshtml）
- Layout 和 Partial Views
- 视图导入和启动文件

⚠️ **限制**
- 不能修改 C# 代码（Controller、Model、Service 等）
- 首次访问修改后的页面会有轻微延迟
- 需要确保服务器有 .NET Runtime
