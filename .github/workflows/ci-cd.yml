name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 构建和测试作业
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Restore dependencies
      run: |
        dotnet restore TtsWebApp/TtsWebApp.csproj
        dotnet restore TtsWebApi/TtsWebApi.csproj
        
    - name: Build
      run: |
        dotnet build TtsWebApp/TtsWebApp.csproj --configuration Release --no-restore
        dotnet build TtsWebApi/TtsWebApi.csproj --configuration Release --no-restore
        
    - name: Test
      run: |
        dotnet test TtsWebApp/TtsWebApp.csproj --configuration Release --no-build --verbosity normal
        dotnet test TtsWebApi/TtsWebApi.csproj --configuration Release --no-build --verbosity normal

  # Docker构建和推送作业
  build-and-push-docker:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          
    - name: Build and push Docker image - WebApp
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.webapp
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-webapp:latest
        labels: ${{ steps.meta.outputs.labels }}
        
    - name: Build and push Docker image - WebApi
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.webapi
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-webapi:latest
        labels: ${{ steps.meta.outputs.labels }}

  # 部署到服务器 - Supervisor模式
  deploy-supervisor:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Publish WebApp
      run: |
        dotnet publish TtsWebApp/TtsWebApp.csproj --configuration Release --output ./publish/webapp --self-contained false --runtime linux-x64
        
    - name: Publish WebApi
      run: |
        dotnet publish TtsWebApi/TtsWebApi.csproj --configuration Release --output ./publish/webapi --self-contained false --runtime linux-x64
        
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 60s
        debug: true
        script: |
          # 创建部署目录
          mkdir -p ${{ secrets.DEPLOY_PATH }}
          cd ${{ secrets.DEPLOY_PATH }}
          
          # 备份当前版本
          if [ -d "current" ]; then
            cp -r current backup-$(date +%Y%m%d%H%M%S)
          fi
          
          # 创建新版本目录
          mkdir -p new-version
          cd new-version
          
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        source: "publish/*"
        target: "${{ secrets.DEPLOY_PATH }}/new-version/"
        strip_components: 1
        
    - name: Setup and restart services
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 60s
        debug: true
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          
          # 复制配置文件
          cp current/appsettings.Production.json new-version/webapp/ 2>/dev/null || true
          cp current/appsettings.Production.json new-version/webapi/ 2>/dev/null || true
          
          # 复制supervisor配置
          cp deploy/supervisor/tts-webapp.conf /etc/supervisor/conf.d/
          cp deploy/supervisor/tts-webapi.conf /etc/supervisor/conf.d/
          
          # 停止旧服务
          supervisorctl stop tts-webapp tts-webapi || true
          
          # 切换到新版本
          rm -rf current
          mv new-version current
          
          # 设置权限
          chmod +x current/webapp/TtsWebApp
          chmod +x current/webapi/TtsWebApi
          
          # 重新加载并启动服务
          supervisorctl reread
          supervisorctl update
          supervisorctl start tts-webapp tts-webapi
          
          # 检查服务状态
          supervisorctl status tts-webapp tts-webapi

  # 部署到服务器 - Docker模式
  deploy-docker:
    needs: build-and-push-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DOCKER_SERVER_HOST }}
        username: ${{ secrets.DOCKER_SERVER_USERNAME }}
        key: ${{ secrets.DOCKER_SERVER_SSH_KEY }}
        port: ${{ secrets.DOCKER_SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 60s
        debug: true
        script: |
          # 创建部署目录
          mkdir -p ${{ secrets.DOCKER_DEPLOY_PATH }}
          cd ${{ secrets.DOCKER_DEPLOY_PATH }}
          
          # 登录到容器注册表
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          
          # 拉取最新镜像
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-webapp:latest
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-webapi:latest
          
          # 停止并删除旧容器
          docker-compose down || true
          
          # 更新docker-compose文件中的镜像标签
          sed -i "s|IMAGE_TAG|latest|g" docker-compose.yml
          
          # 启动新容器
          docker-compose up -d
          
          # 清理旧镜像
          docker image prune -f