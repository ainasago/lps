@{
    ViewData["Title"] = "文字转语音";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>文字转语音</h4>
                </div>
                <div class="card-body">
                    <form id="ttsForm">
                        <div class="mb-3">
                            <label for="textInput" class="form-label">输入文本</label>
                            <textarea class="form-control" id="textInput" rows="5" placeholder="请输入要转换的文本..."></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="languageSelect" class="form-label">语言</label>
                                <select class="form-select" id="languageSelect">
                                    <option value="">选择语言...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="voiceSelect" class="form-label">配音员</label>
                                <select class="form-select" id="voiceSelect">
                                    <option value="">选择配音员...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="pitchRange" class="form-label">音调: <span id="pitchValue">0</span></label>
                                <input type="range" class="form-range" id="pitchRange" min="-50" max="50" value="0">
                            </div>
                            <div class="col-md-4">
                                <label for="rateRange" class="form-label">语速: <span id="rateValue">0</span></label>
                                <input type="range" class="form-range" id="rateRange" min="-100" max="200" value="0">
                            </div>
                            <div class="col-md-4">
                                <label for="volumeRange" class="form-label">音量: <span id="volumeValue">80</span>%</label>
                                <input type="range" class="form-range" id="volumeRange" min="0" max="100" value="80">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generateSubtitles">
                                <label class="form-check-label" for="generateSubtitles">
                                    生成字幕
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-primary" id="convertBtn">转换</button>
                            <button type="button" class="btn btn-success" id="playBtn" disabled>播放</button>
                            <button type="button" class="btn btn-info" id="downloadAudioBtn" disabled>下载音频</button>
                            <button type="button" class="btn btn-warning" id="downloadSubtitlesBtn" disabled>下载字幕</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4" id="resultSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>转换结果</h4>
                </div>
                <div class="card-body">
                    <audio id="audioPlayer" controls class="w-100 mb-3"></audio>
                    <div id="subtitlesContainer" class="border p-3" style="height: 200px; overflow-y: auto; display: none;">
                        <h5>字幕内容</h5>
                        <div id="subtitlesContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let voices = [];
        let currentAudioData = null;
        let currentSubtitles = null;
        
        $(document).ready(function() {
            loadVoices();
            
            // 滑块值更新
            $('#pitchRange').on('input', function() {
                $('#pitchValue').text($(this).val());
            });
            
            $('#rateRange').on('input', function() {
                $('#rateValue').text($(this).val());
            });
            
            $('#volumeRange').on('input', function() {
                $('#volumeValue').text($(this).val());
            });
            
            // 语言选择变化时更新配音员列表
            $('#languageSelect').on('change', function() {
                updateVoiceList($(this).val());
            });
            
            // 转换按钮点击事件
            $('#convertBtn').on('click', function() {
                convertText();
            });
            
            // 播放按钮点击事件
            $('#playBtn').on('click', function() {
                playAudio();
            });
            
            // 下载音频按钮点击事件
            $('#downloadAudioBtn').on('click', function() {
                downloadAudio();
            });
            
            // 下载字幕按钮点击事件
            $('#downloadSubtitlesBtn').on('click', function() {
                downloadSubtitles();
            });
        });
        
        function loadVoices() {
            $.get('/Tts/GetVoices', function(data) {
                voices = data;
                populateLanguageSelect();
            }).fail(function() {
                alert('加载语音列表失败');
            });
        }
        
        function populateLanguageSelect() {
            const languages = [...new Set(voices.map(v => v.locale))];
            const languageSelect = $('#languageSelect');
            
            languageSelect.empty().append('<option value="">选择语言...</option>');
            
            // 按语言代码排序
            languages.sort();
            
            // 创建一个语言代码到LocaleName的映射
            const localeNameMap = {};
            voices.forEach(voice => {
                if (!localeNameMap[voice.locale] && voice.localeName) {
                    localeNameMap[voice.locale] = voice.localeName;
                }
            });
            
            languages.forEach(lang => {
                // 使用API返回的LocaleName，如果没有则使用原始语言代码
                const displayName = localeNameMap[lang] || lang;
                languageSelect.append(`<option value="${lang}">${displayName}</option>`);
            });
        }
        
        function updateVoiceList(selectedLanguage) {
            const voiceSelect = $('#voiceSelect');
            voiceSelect.empty().append('<option value="">选择配音员...</option>');
            
            if (selectedLanguage) {
                const filteredVoices = voices.filter(v => v.locale === selectedLanguage);
                filteredVoices.forEach(voice => {
                    // 使用ShortName作为显示名称，因为它更简洁且有意义
                    // 格式: "语言代码-人名Neural" 如 "af-ZA-AdriNeural"
                    const displayName = voice.shortName || voice.name;
                    voiceSelect.append(`<option value="${voice.shortName}">${displayName} (${voice.gender})</option>`);
                });
            }
        }
        
        function convertText() {
            const text = $('#textInput').val().trim();
            const voiceId = $('#voiceSelect').val();
            const language = $('#languageSelect').val();
            const pitch = parseInt($('#pitchRange').val());
            const rate = parseInt($('#rateRange').val());
            const volume = parseInt($('#volumeRange').val());
            const generateSubtitles = $('#generateSubtitles').is(':checked');
            
            if (!text) {
                alert('请输入要转换的文本');
                return;
            }
            
            if (!voiceId) {
                alert('请选择配音员');
                return;
            }
            
            const request = {
                Text: text,
                Voice: voiceId,
                Language: language,
                Pitch: pitch,
                Rate: rate,
                Volume: volume,
                GenerateSubtitles: generateSubtitles
            };
            
            $('#convertBtn').prop('disabled', true).text('转换中...');
            
            $.ajax({
                url: '/Tts/ConvertText',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(request),
                success: function(response) {
                console.log('收到响应:', response);
                if (response.success) {
                    currentAudioData = response.audioData;
                    currentSubtitles = response.subtitles;
                    
                    console.log('音频数据长度:', currentAudioData ? currentAudioData.length : 0);
                    
                    // 启用按钮
                    $('#playBtn, #downloadAudioBtn').prop('disabled', false);
                    if (currentSubtitles) {
                        $('#downloadSubtitlesBtn').prop('disabled', false);
                    }
                    
                    // 显示结果区域
                    $('#resultSection').show();
                    
                    // 设置音频播放器
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = 'data:audio/mpeg;base64,' + currentAudioData;
                    
                    // 添加错误处理
                    audioPlayer.onerror = function(e) {
                        console.error('音频加载错误:', e);
                        alert('音频加载失败，请检查控制台日志');
                    };
                    
                    audioPlayer.onloadedmetadata = function() {
                        console.log('音频元数据加载完成，时长:', audioPlayer.duration);
                    };
                    
                    audioPlayer.load(); // 强制加载音频
                    
                    // 显示字幕
                    if (currentSubtitles) {
                        $('#subtitlesContainer').show();
                        $('#subtitlesContent').text(currentSubtitles);
                    } else {
                        $('#subtitlesContainer').hide();
                    }
                } else {
                    alert('转换失败: ' + response.errorMessage);
                }
            },
            error: function() {
                alert('转换请求失败');
            },
            complete: function() {
                $('#convertBtn').prop('disabled', false).text('转换');
            }
            });
        }
        
        function playAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer.src) {
                audioPlayer.play();
            }
        }
        
        function downloadAudio() {
            if (currentAudioData) {
                const a = document.createElement('a');
                a.href = 'data:audio/mpeg;base64,' + currentAudioData;
                a.download = 'tts_audio.mp3';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
        
        function downloadSubtitles() {
            if (currentSubtitles) {
                const a = document.createElement('a');
                a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(currentSubtitles);
                a.download = 'tts_subtitles.srt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }
    </script>
}