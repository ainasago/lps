# 文件管理系统使用说明

## 功能概述

文件管理系统是一个功能完整的在线文件管理工具，允许管理员在发布后直接管理服务器上的文件。

## 核心功能

### 1. 文件浏览
- ✅ 浏览 `publish` 目录下的所有文件和文件夹
- ✅ 面包屑导航，快速跳转到父目录
- ✅ 文件信息显示：图标、名称、大小、修改时间
- ✅ 自动排序：文件夹在前，按名称排序
- ✅ 排除系统目录：bin, obj, .git, .vs, node_modules

### 2. 文件编辑
- ✅ 使用 **Monaco Editor**（VS Code 同款编辑器）
- ✅ 语法高亮支持 30+ 种语言
- ✅ 智能代码补全
- ✅ 代码折叠、查找替换
- ✅ 暗色主题
- ✅ 快捷键：Ctrl+S 保存
- ✅ 自动检测文件类型
- ✅ 不限制文件后缀，尝试打开任何文件
- ✅ 二进制文件自动检测并提示
- ✅ 自动备份（保存前创建 .bak 文件）

### 3. 图片预览
- ✅ 使用 **Viewer.js** 图片查看器
- ✅ 大图预览、缩放、旋转、翻转
- ✅ 全屏模式
- ✅ 缩略图导航
- ✅ 键盘导航：← → 切换图片，ESC 返回
- ✅ 支持格式：JPG, PNG, GIF, SVG, WebP, BMP

### 4. 文件上传
- ✅ 单文件上传
- ✅ 文件大小限制：20MB
- ✅ 文件类型验证
- ✅ 文件名冲突自动处理（添加时间戳）
- ✅ 上传进度显示

### 5. 文件夹管理
- ✅ 创建新文件夹
- ✅ 文件夹名称验证
- ✅ 递归删除文件夹

### 6. 文件操作
- ✅ 重命名文件/文件夹
- ✅ 删除文件/文件夹（带确认）
- ✅ 下载文件
- ✅ 文件信息查看

## 配置说明

### appsettings.json 配置

```json
{
  "FileManager": {
    "RootPath": "publish",                    // 管理的根目录
    "MaxFileSize": 20971520,                  // 最大文件大小 (20MB)
    "AllowedUploadExtensions": [              // 允许上传的文件类型
      ".txt", ".cs", ".cshtml", ".json", ".xml", ".md",
      ".js", ".css", ".html", ".config", ".sql",
      ".jpg", ".jpeg", ".png", ".gif", ".svg", ".webp", ".bmp",
      ".pdf", ".zip", ".rar"
    ],
    "ImageExtensions": [                      // 图片类型
      ".jpg", ".jpeg", ".png", ".gif", ".svg", ".webp", ".bmp"
    ],
    "ExcludedPaths": [                        // 排除的路径
      "bin", "obj", ".git", ".vs", "node_modules", ".vscode"
    ]
  }
}
```

### 修改配置

1. **更改管理目录**：修改 `RootPath`
2. **调整文件大小限制**：修改 `MaxFileSize`（字节）
3. **添加允许的文件类型**：在 `AllowedUploadExtensions` 中添加
4. **排除更多目录**：在 `ExcludedPaths` 中添加

## 使用方法

### 访问文件管理器

1. 登录管理后台
2. 点击侧边栏的 **"文件管理"** 菜单
3. 默认显示 `publish` 目录

### 浏览文件

- 点击文件夹名称进入子目录
- 使用面包屑导航快速返回上级目录
- 文件列表显示文件图标、大小、修改时间

### 编辑文件

1. 点击文件行的 **编辑** 按钮（蓝色笔图标）
2. Monaco Editor 自动识别文件类型并应用语法高亮
3. 编辑完成后点击 **保存** 按钮或按 `Ctrl+S`
4. 保存成功会显示提示信息

**支持的文件类型**：
- 代码文件：C#, JavaScript, TypeScript, Python, Java, C++, Go, Rust 等
- Web 文件：HTML, CSS, SCSS, JSON, XML
- 配置文件：JSON, XML, YAML, Config
- 文档文件：Markdown, TXT, LOG
- 数据库：SQL

**注意事项**：
- 二进制文件无法编辑，会显示错误提示
- 保存前会自动创建 `.bak` 备份文件
- 离开页面前会提示保存未保存的更改

### 预览图片

1. 点击图片文件行的 **预览** 按钮（紫色眼睛图标）
2. 查看大图，支持缩放、旋转、翻转
3. 点击图片进入全屏查看模式
4. 使用缩略图导航切换同目录下的其他图片
5. 键盘快捷键：
   - `←` 上一张
   - `→` 下一张
   - `ESC` 返回列表

### 上传文件

1. 点击工具栏的 **上传文件** 按钮
2. 选择要上传的文件（最大 20MB）
3. 点击 **上传** 按钮
4. 上传成功后自动刷新列表

### 创建文件夹

1. 点击工具栏的 **新建文件夹** 按钮
2. 输入文件夹名称
3. 点击 **创建** 按钮

### 重命名

1. 点击文件/文件夹行的 **重命名** 按钮（黄色图标）
2. 输入新名称
3. 点击 **重命名** 按钮

### 删除

1. 点击文件/文件夹行的 **删除** 按钮（红色垃圾桶图标）
2. 确认删除操作
3. 文件夹删除会递归删除所有内容

### 下载文件

1. 点击文件行的 **下载** 按钮（绿色下载图标）
2. 文件会自动下载到本地

## 安全特性

### 路径安全
- ✅ 防止路径遍历攻击（`..`, `~`）
- ✅ 所有路径必须在配置的根目录内
- ✅ 路径验证和规范化

### 访问控制
- ✅ 所有操作需要管理员登录
- ✅ CSRF 令牌保护
- ✅ 表单验证

### 文件验证
- ✅ 文件大小限制
- ✅ 文件类型白名单
- ✅ 文件名非法字符检查
- ✅ 二进制文件检测

### 数据保护
- ✅ 自动备份（编辑文件时）
- ✅ 删除确认提示
- ✅ 离开页面前保存提醒

## 技术栈

### 后端
- **ASP.NET Core 9.0** - Web 框架
- **依赖注入** - 服务管理
- **配置系统** - 灵活配置

### 前端
- **Tailwind CSS** - UI 样式
- **Material Icons** - 图标库
- **Monaco Editor** - 代码编辑器（VS Code 同款）
- **Viewer.js** - 图片查看器
- **原生 JavaScript** - 交互逻辑

### 架构设计
- **服务层模式** - `IFileManagerService`
- **配置驱动** - 所有设置可配置
- **安全优先** - 多层安全验证
- **无硬编码** - 所有路径和配置都可修改

## 常见问题

### Q: 为什么某些文件无法编辑？
A: 二进制文件（如 DLL、EXE、图片等）无法作为文本编辑。系统会自动检测并提示。

### Q: 上传文件失败？
A: 检查以下几点：
1. 文件大小是否超过 20MB
2. 文件类型是否在允许列表中
3. 磁盘空间是否充足

### Q: 如何修改文件大小限制？
A: 在 `appsettings.json` 中修改 `FileManager:MaxFileSize`（单位：字节）

### Q: 如何添加更多允许的文件类型？
A: 在 `appsettings.json` 的 `FileManager:AllowedUploadExtensions` 数组中添加扩展名

### Q: 删除的文件可以恢复吗？
A: 删除操作是永久性的，建议在删除重要文件前先备份

### Q: 编辑文件时的备份文件在哪里？
A: 保存文件时会在同目录下创建 `.bak` 后缀的备份文件

## 最佳实践

### 1. 定期备份
- 在编辑重要文件前先下载备份
- 利用自动生成的 `.bak` 文件

### 2. 权限管理
- 只授权可信的管理员访问
- 定期更改管理员密码

### 3. 文件组织
- 合理使用文件夹组织文件
- 使用有意义的文件名

### 4. 性能优化
- 避免上传过大的文件
- 定期清理不需要的文件

### 5. 安全建议
- 不要上传可执行文件到 Web 可访问目录
- 定期检查上传的文件
- 监控磁盘空间使用

## 更新日志

### v1.0.0 (2025-11-07)
- ✅ 初始版本发布
- ✅ 文件浏览、编辑、上传、删除功能
- ✅ Monaco Editor 集成
- ✅ Viewer.js 图片预览
- ✅ 完整的安全验证
- ✅ 响应式设计

## 支持

如有问题或建议，请联系系统管理员。
