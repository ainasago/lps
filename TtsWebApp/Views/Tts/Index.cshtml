@{
    ViewData["Title"] = "å…è´¹åœ¨çº¿AIæ–‡å­—è½¬è¯­éŸ³";
}

<!-- Hero Section / Core Tool -->
<section class="py-16 px-4">
<div class="container mx-auto flex flex-col items-center text-center gap-4">
<h1 class="text-slate-900 dark:text-white text-4xl md:text-5xl font-bold leading-tight tracking-[-0.033em] max-w-3xl" data-i18n="home.title">
å®‰å¦®è¯­éŸ³è½¬æ¢ - å…è´¹AIæ–‡å­—è½¬è¯­éŸ³å·¥å…·
</h1>
<h2 class="text-slate-600 dark:text-slate-400 text-base md:text-lg font-normal leading-normal max-w-2xl" data-i18n="home.subtitle">
æ”¯æŒå¤šç§è¯­è¨€å’Œè‡ªç„¶äººå£°ï¼Œä¸ºæ‚¨çš„è§†é¢‘ã€æ’­å®¢å’Œæ¼”ç¤ºæ–‡ç¨¿åˆ›å»ºé«˜è´¨é‡éŸ³é¢‘
</h2>
</div>

<div class="container mx-auto mt-12 p-4 sm:p-6 md:p-8 bg-white/50 dark:bg-white/5 border border-slate-200 dark:border-slate-800 rounded-xl max-w-5xl">
<form id="ttsForm">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-2">
<label class="flex flex-col w-full">
<div class="flex justify-between items-center pb-2">
<p class="text-slate-800 dark:text-slate-200 text-base font-medium leading-normal" data-i18n="home.inputLabel">åœ¨æ­¤è¾“å…¥æ‚¨çš„æ–‡æœ¬</p>
<p class="text-slate-500 dark:text-slate-400 text-xs" id="charCount">0 / 5000</p>
</div>
<textarea 
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary border-slate-300 dark:border-slate-700 bg-background-light dark:bg-background-dark min-h-64 placeholder:text-slate-400 dark:placeholder:text-slate-500 p-4 text-base font-normal leading-normal" 
                            id="textInput" 
                            placeholder="ç²˜è´´æˆ–è¾“å…¥æ‚¨çš„æ–‡æœ¬..."
                            data-i18n="home.placeholder"
                            maxlength="5000"></textarea>
</label>
</div>
<div class="flex flex-col gap-6">
<div>
<label class="block text-slate-800 dark:text-slate-200 text-base font-medium leading-normal pb-2" for="languageSelect" data-i18n="home.language">è¯­è¨€</label>
<select class="form-select w-full rounded-lg text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary border-slate-300 dark:border-slate-700 bg-background-light dark:bg-background-dark placeholder:text-slate-400 dark:placeholder:text-slate-500" id="languageSelect">
<option value="">é€‰æ‹©è¯­è¨€...</option>
</select>
</div>
<div>
<p class="text-slate-800 dark:text-slate-200 text-base font-medium leading-normal pb-2" data-i18n="home.voice">é…éŸ³å‘˜</p>
<select class="form-select w-full rounded-lg text-slate-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary border-slate-300 dark:border-slate-700 bg-background-light dark:bg-background-dark" id="voiceSelect">
<option value="">é€‰æ‹©é…éŸ³å‘˜...</option>
</select>
</div>
<div>
<label class="block text-slate-800 dark:text-slate-200 text-base font-medium leading-normal pb-2" for="pitchRange"><span data-i18n="home.pitch">éŸ³è°ƒ</span>: <span id="pitchValue">0</span></label>
<input class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary" id="pitchRange" max="50" min="-50" step="1" type="range" value="0"/>
</div>
<div>
<label class="block text-slate-800 dark:text-slate-200 text-base font-medium leading-normal pb-2" for="rateRange"><span data-i18n="home.rate">è¯­é€Ÿ</span>: <span id="rateValue">0</span></label>
<input class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary" id="rateRange" max="200" min="-100" step="1" type="range" value="0"/>
</div>
<div>
<label class="block text-slate-800 dark:text-slate-200 text-base font-medium leading-normal pb-2" for="volumeRange"><span data-i18n="home.volume">éŸ³é‡</span>: <span id="volumeValue">80</span></label>
<input class="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-primary" id="volumeRange" max="100" min="0" step="1" type="range" value="80"/>
</div>
<div class="flex items-center gap-2">
<input type="checkbox" id="generateSubtitles" class="w-4 h-4 text-primary bg-slate-100 border-slate-300 rounded focus:ring-primary">
<label for="generateSubtitles" class="text-slate-800 dark:text-slate-200 text-sm font-medium" data-i18n="home.generateSubtitles">ç”Ÿæˆå­—å¹•</label>
</div>

<!-- é«˜çº§åŠŸèƒ½ -->
<div class="mt-4 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700">
<h3 class="text-slate-900 dark:text-white text-sm font-bold mb-3">
<span class="material-symbols-outlined text-base align-middle mr-1">tune</span>
é«˜çº§åŠŸèƒ½
</h3>
<div class="space-y-3">
<!-- è¯•å¬æ¨¡å¼ -->
<div class="flex items-center gap-2">
<input type="checkbox" id="previewMode" class="w-4 h-4 text-primary bg-slate-100 border-slate-300 rounded focus:ring-primary">
<label for="previewMode" class="text-slate-800 dark:text-slate-200 text-sm font-medium">è¯•å¬æ¨¡å¼ï¼ˆåªåˆæˆå‰</label>
<input type="number" id="previewSentences" class="w-16 px-2 py-1 text-sm border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-white" value="3" min="1" max="10">
<label class="text-slate-800 dark:text-slate-200 text-sm font-medium">å¥ï¼‰</label>
</div>

<!-- åœé¡¿é—´éš” -->
<div class="flex items-center gap-2">
<label class="text-slate-800 dark:text-slate-200 text-sm font-medium">å¥é—´åœé¡¿ï¼š</label>
<input type="number" id="breakTime" class="w-20 px-2 py-1 text-sm border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-white" value="0" min="0" max="2000" step="100">
<label class="text-slate-800 dark:text-slate-200 text-sm">æ¯«ç§’</label>
<span class="text-slate-500 dark:text-slate-400 text-xs">(0=æ— åœé¡¿)</span>
</div>

<!-- é•¿æ–‡æœ¬åˆ‡ç‰‡ -->
<div class="flex items-center gap-2">
<input type="checkbox" id="enableLongTextSplit" class="w-4 h-4 text-primary bg-slate-100 border-slate-300 rounded focus:ring-primary">
<label for="enableLongTextSplit" class="text-slate-800 dark:text-slate-200 text-sm font-medium">é•¿æ–‡æœ¬åˆ‡ç‰‡ï¼ˆæ¯ç‰‡</label>
<input type="number" id="maxCharsPerChunk" class="w-20 px-2 py-1 text-sm border border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 text-slate-900 dark:text-white" value="500" min="100" max="2000" step="100">
<label class="text-slate-800 dark:text-slate-200 text-sm font-medium">å­—ï¼‰</label>
</div>
</div>
</div>

</div>
</div>
<div class="mt-8 flex flex-col md:flex-row gap-4 items-center">
<button type="button" id="convertBtn" class="flex w-full md:w-auto min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:opacity-90">
<span class="material-symbols-outlined mr-2">graphic_eq</span>
<span class="truncate" data-i18n="home.generateSpeech">ç”Ÿæˆè¯­éŸ³</span>
</button>
<div id="inlinePlayer" class="flex items-center w-full grow bg-slate-200 dark:bg-slate-800 rounded-lg p-2" style="display: none;">
<button type="button" id="playBtn" class="flex items-center justify-center size-8 rounded-full bg-slate-400 dark:bg-slate-600 text-white hover:bg-primary">
<span class="material-symbols-outlined text-xl">play_arrow</span>
</button>
<div class="flex-grow h-1 bg-slate-300 dark:bg-slate-600 mx-3 rounded-full"></div>
<p class="text-sm text-slate-600 dark:text-slate-400" id="timeDisplay">0:00 / 0:00</p>
<button type="button" id="downloadAudioBtn" class="flex items-center justify-center size-8 ml-3 text-slate-600 dark:text-slate-400 hover:text-primary">
<span class="material-symbols-outlined text-xl">download</span>
</button>
</div>
</div>
<audio id="audioPlayer" style="display: none;"></audio>
<div id="subtitlesContainer" class="mt-6 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4" style="display: none;">
<div class="flex justify-between items-center mb-3">
<h4 class="text-slate-900 dark:text-white text-lg font-bold">å­—å¹•å†…å®¹</h4>
<button type="button" id="downloadSubtitlesBtn" class="flex items-center gap-2 px-3 py-1 bg-amber-600 text-white text-sm rounded-lg hover:opacity-90">
<span class="material-symbols-outlined text-sm">download</span>
<span>ä¸‹è½½å­—å¹•</span>
</button>
</div>
<div id="subtitlesContent" class="text-slate-700 dark:text-slate-300 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto"></div>
</div>
</form>
</div>
</section>

<!-- Features Section -->
<section class="py-16 px-4 bg-white/50 dark:bg-white/5">
<div class="container mx-auto">
<div class="text-center mb-12">
<h2 class="text-3xl font-bold text-slate-900 dark:text-white">ä¸ºä»€ä¹ˆé€‰æ‹©æˆ‘ä»¬</h2>
<p class="text-slate-600 dark:text-slate-400 mt-2">æ¢ç´¢è®©æˆ‘ä»¬çš„ TTS æœåŠ¡è„±é¢–è€Œå‡ºçš„åŠŸèƒ½ç‰¹æ€§</p>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
<div class="flex flex-col items-center text-center p-6">
<div class="flex items-center justify-center size-14 rounded-xl bg-primary/20 mb-4">
<span class="material-symbols-outlined text-primary text-3xl">language</span>
</div>
<p class="text-slate-900 dark:text-white text-lg font-bold leading-tight">å…¨çƒè¯­è¨€è¦†ç›–</p>
<p class="text-slate-600 dark:text-slate-400 mt-1 text-sm">æ”¯æŒå…¨çƒæ•°åç§è¯­è¨€å’Œæ–¹è¨€</p>
</div>
<div class="flex flex-col items-center text-center p-6">
<div class="flex items-center justify-center size-14 rounded-xl bg-primary/20 mb-4">
<span class="material-symbols-outlined text-primary text-3xl">psychology</span>
</div>
<p class="text-slate-900 dark:text-white text-lg font-bold leading-tight">AI é©±åŠ¨çš„è‡ªç„¶è¯­éŸ³</p>
<p class="text-slate-600 dark:text-slate-400 mt-1 text-sm">åˆ©ç”¨å°–ç«¯ AI æŠ€æœ¯å®ç°æå…¶é€¼çœŸçš„äººå£°</p>
</div>
<div class="flex flex-col items-center text-center p-6">
<div class="flex items-center justify-center size-14 rounded-xl bg-primary/20 mb-4">
<span class="material-symbols-outlined text-primary text-3xl">folder_zip</span>
</div>
<p class="text-slate-900 dark:text-white text-lg font-bold leading-tight">å¤šç§éŸ³é¢‘æ ¼å¼</p>
<p class="text-slate-600 dark:text-slate-400 mt-1 text-sm">å¯¼å‡º MP3ã€WAV ç­‰æµè¡Œæ ¼å¼çš„éŸ³é¢‘</p>
</div>
<div class="flex flex-col items-center text-center p-6">
<div class="flex items-center justify-center size-14 rounded-xl bg-primary/20 mb-4">
<span class="material-symbols-outlined text-primary text-3xl">api</span>
</div>
<p class="text-slate-900 dark:text-white text-lg font-bold leading-tight">å¼€å‘è€… API</p>
<p class="text-slate-600 dark:text-slate-400 mt-1 text-sm">è½»æ¾å°†æˆ‘ä»¬å¼ºå¤§çš„ TTS å¼•æ“é›†æˆåˆ°æ‚¨çš„åº”ç”¨ä¸­</p>
</div>
</div>
</div>
</section>

<!-- Use Cases Section -->
<section class="py-16 px-4">
<div class="container mx-auto">
<div class="text-center mb-12">
<h2 class="text-3xl font-bold text-slate-900 dark:text-white">é€‚ç”¨äºä»»ä½•åœºæ™¯</h2>
<p class="text-slate-600 dark:text-slate-400 mt-2">ä»åˆ›æ„é¡¹ç›®åˆ°å•†ä¸šåº”ç”¨ï¼Œæˆ‘ä»¬éƒ½èƒ½æ»¡è¶³æ‚¨çš„éœ€æ±‚</p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
<div class="flex flex-col items-stretch justify-start rounded-xl bg-white/50 dark:bg-white/5 border border-slate-200 dark:border-slate-800 overflow-hidden">
<div class="w-full bg-center bg-no-repeat aspect-video bg-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3a4.svg'); background-size: 100px; background-color: #5b13ec20;"></div>
<div class="p-6">
<p class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">è§†é¢‘å’Œæ’­å®¢æ—ç™½</p>
<p class="text-slate-600 dark:text-slate-400 mt-1 text-sm">æ— éœ€éº¦å…‹é£å³å¯ä¸ºæ‚¨çš„å†…å®¹åˆ›å»ºä¸“ä¸šé…éŸ³</p>
</div>
</div>
<div class="flex flex-col items-stretch justify-start rounded-xl bg-white/50 dark:bg-white/5 border border-slate-200 dark:border-slate-800 overflow-hidden">
<div class="w-full bg-center bg-no-repeat aspect-video bg-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4da.svg'); background-size: 100px; background-color: #5b13ec20;"></div>
<div class="p-6">
<p class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">åœ¨çº¿å­¦ä¹ ä¸æ•™è‚²</p>
<p class="text-slate-600 dark:text-slate-400 mt-1 text-sm">ä¸ºè¯¾ç¨‹å’Œæ•™è‚²å†…å®¹åˆ¶ä½œå¼•äººå…¥èƒœçš„éŸ³é¢‘ææ–™</p>
</div>
</div>
<div class="flex flex-col items-stretch justify-start rounded-xl bg-white/50 dark:bg-white/5 border border-slate-200 dark:border-slate-800 overflow-hidden">
<div class="w-full bg-center bg-no-repeat aspect-video bg-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f4e2.svg'); background-size: 100px; background-color: #5b13ec20;"></div>
<div class="p-6">
<p class="text-slate-900 dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">è¥é”€ä¸å¹¿å‘Š</p>
<p class="text-slate-600 dark:text-slate-400 mt-1 text-sm">åœ¨å‡ åˆ†é’Ÿå†…åˆ¶ä½œå¼•äººæ³¨ç›®çš„éŸ³é¢‘å¹¿å‘Šå’Œå®£ä¼ å†…å®¹</p>
</div>
</div>
</div>
</div>
</section>

@section Scripts {
<script>
let voices = [];
let currentAudioData = null;
let currentSubtitles = null;

$(document).ready(function() {
    loadVoices();
    
    $('#textInput').on('input', function() {
        $('#charCount').text($(this).val().length + ' / 5000');
    });
    
    $('#pitchRange').on('input', function() {
        $('#pitchValue').text($(this).val());
    });
    
    $('#rateRange').on('input', function() {
        $('#rateValue').text($(this).val());
    });
    
    $('#volumeRange').on('input', function() {
        $('#volumeValue').text($(this).val());
    });
    
    $('#languageSelect').on('change', function() {
        updateVoiceList($(this).val());
    });
    
    $('#convertBtn').on('click', function() {
        convertText();
    });
    
    $('#playBtn').on('click', function() {
        playAudio();
    });
    
    $('#downloadAudioBtn').on('click', function() {
        downloadAudio();
    });
    
    $('#downloadSubtitlesBtn').on('click', function() {
        downloadSubtitles();
    });
    
    const audioPlayer = document.getElementById('audioPlayer');
    audioPlayer.addEventListener('timeupdate', updateProgress);
    audioPlayer.addEventListener('ended', function() {
        $('#playBtn .material-symbols-outlined').text('play_arrow');
    });
});

function loadVoices() {
    $.get('/Tts/GetVoices', function(data) {
        voices = data;
        populateLanguageSelect();
    }).fail(function() {
        alert('åŠ è½½è¯­éŸ³åˆ—è¡¨å¤±è´¥');
    });
}

function populateLanguageSelect() {
    const languages = [...new Set(voices.map(v => v.locale))];
    const languageSelect = $('#languageSelect');
    languageSelect.empty().append('<option value="">é€‰æ‹©è¯­è¨€...</option>');
    languages.sort();
    const localeNameMap = {};
    voices.forEach(voice => {
        if (!localeNameMap[voice.locale] && voice.localeName) {
            localeNameMap[voice.locale] = voice.localeName;
        }
    });
    languages.forEach(lang => {
        const displayName = localeNameMap[lang] || lang;
        languageSelect.append(`<option value="${lang}">${displayName}</option>`);
    });
    
    // è‡ªåŠ¨æ£€æµ‹æµè§ˆå™¨è¯­è¨€å¹¶é€‰æ‹©é»˜è®¤è¯­è¨€
    autoSelectLanguage();
}

function autoSelectLanguage() {
    // è·å–æµè§ˆå™¨è¯­è¨€
    const browserLang = navigator.language || navigator.userLanguage;
    console.log('æµè§ˆå™¨è¯­è¨€:', browserLang);
    
    // è¯­è¨€æ˜ å°„è¡¨
    const langMap = {
        'zh': 'zh-CN',
        'zh-CN': 'zh-CN',
        'zh-TW': 'zh-TW',
        'zh-HK': 'zh-HK',
        'en': 'en-US',
        'en-US': 'en-US',
        'en-GB': 'en-GB',
        'ja': 'ja-JP',
        'ko': 'ko-KR',
        'fr': 'fr-FR',
        'de': 'de-DE',
        'es': 'es-ES'
    };
    
    // å°è¯•ç²¾ç¡®åŒ¹é…
    let matchedLocale = null;
    const browserLangLower = browserLang.toLowerCase();
    
    // é¦–å…ˆå°è¯•å®Œå…¨åŒ¹é…
    for (const [key, value] of Object.entries(langMap)) {
        if (browserLangLower === key.toLowerCase()) {
            matchedLocale = value;
            break;
        }
    }
    
    // å¦‚æœæ²¡æœ‰å®Œå…¨åŒ¹é…ï¼Œå°è¯•åŒ¹é…è¯­è¨€ä»£ç ï¼ˆå¦‚ zh-CN åŒ¹é… zhï¼‰
    if (!matchedLocale) {
        const langCode = browserLangLower.split('-')[0];
        matchedLocale = langMap[langCode];
    }
    
    // è·å–å¯ç”¨è¯­è¨€åˆ—è¡¨
    const availableLocales = voices.map(v => v.locale);
    let selectedLocale = null;
    
    // æ£€æŸ¥åŒ¹é…çš„è¯­è¨€æ˜¯å¦åœ¨å¯ç”¨è¯­è¨€åˆ—è¡¨ä¸­
    if (matchedLocale) {
        const exactMatch = availableLocales.find(l => l === matchedLocale);
        
        if (exactMatch) {
            selectedLocale = exactMatch;
            console.log('ç²¾ç¡®åŒ¹é…è¯­è¨€:', selectedLocale);
        } else {
            // å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼ˆå¦‚ zh-CN åŒ¹é… zh-*ï¼‰
            const langPrefix = matchedLocale.split('-')[0];
            const fuzzyMatch = availableLocales.find(l => l.startsWith(langPrefix));
            if (fuzzyMatch) {
                selectedLocale = fuzzyMatch;
                console.log('æ¨¡ç³ŠåŒ¹é…è¯­è¨€:', selectedLocale);
            }
        }
    }
    
    // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•è¯­è¨€ï¼Œé»˜è®¤é€‰æ‹©è‹±æ–‡
    if (!selectedLocale) {
        // å°è¯•æ‰¾ en-US
        selectedLocale = availableLocales.find(l => l === 'en-US');
        
        // å¦‚æœæ²¡æœ‰ en-USï¼Œæ‰¾ä»»ä½• en- å¼€å¤´çš„
        if (!selectedLocale) {
            selectedLocale = availableLocales.find(l => l.startsWith('en-'));
        }
        
        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨è¯­è¨€
        if (!selectedLocale && availableLocales.length > 0) {
            selectedLocale = availableLocales[0];
        }
        
        console.log('ä½¿ç”¨é»˜è®¤è¯­è¨€:', selectedLocale);
    }
    
    // è®¾ç½®é€‰ä¸­çš„è¯­è¨€
    if (selectedLocale) {
        $('#languageSelect').val(selectedLocale);
        updateVoiceList(selectedLocale);
        console.log('æœ€ç»ˆé€‰æ‹©è¯­è¨€:', selectedLocale);
        
        // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªé…éŸ³å‘˜
        setTimeout(() => {
            const firstVoice = $('#voiceSelect option:eq(1)').val();
            if (firstVoice) {
                $('#voiceSelect').val(firstVoice);
                console.log('è‡ªåŠ¨é€‰æ‹©é…éŸ³å‘˜:', firstVoice);
            }
        }, 100);
    }
}

function updateVoiceList(selectedLanguage) {
    const voiceSelect = $('#voiceSelect');
    voiceSelect.empty().append('<option value="">é€‰æ‹©é…éŸ³å‘˜...</option>');
    if (selectedLanguage) {
        const filteredVoices = voices.filter(v => v.locale === selectedLanguage);
        filteredVoices.forEach(voice => {
            const displayName = voice.shortName || voice.name;
            voiceSelect.append(`<option value="${voice.shortName}">${displayName} (${voice.gender})</option>`);
        });
    }
}

function convertText() {
    const text = $('#textInput').val().trim();
    const voiceId = $('#voiceSelect').val();
    const language = $('#languageSelect').val();
    const pitch = parseInt($('#pitchRange').val());
    const rate = parseInt($('#rateRange').val());
    const volume = parseInt($('#volumeRange').val());
    const generateSubtitles = $('#generateSubtitles').is(':checked');
    
    // é«˜çº§åŠŸèƒ½å‚æ•°
    const previewMode = $('#previewMode').is(':checked');
    const previewSentences = parseInt($('#previewSentences').val()) || 3;
    const breakTime = parseInt($('#breakTime').val()) || 0;
    const enableLongTextSplit = $('#enableLongTextSplit').is(':checked');
    const maxCharsPerChunk = parseInt($('#maxCharsPerChunk').val()) || 500;
    
    if (!text) {
        alert('è¯·è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬');
        return;
    }
    if (!voiceId) {
        alert('è¯·é€‰æ‹©é…éŸ³å‘˜');
        return;
    }
    
    const request = {
        Text: text,
        Voice: voiceId,
        Language: language,
        Pitch: pitch,
        Rate: rate,
        Volume: volume,
        GenerateSubtitles: generateSubtitles,
        // é«˜çº§åŠŸèƒ½
        PreviewMode: previewMode,
        PreviewSentences: previewSentences,
        BreakTime: breakTime,
        EnableLongTextSplit: enableLongTextSplit,
        MaxCharsPerChunk: maxCharsPerChunk
    };
    
    console.log('å‘é€è¯·æ±‚:', request);
    
    const $convertBtn = $('#convertBtn');
    $convertBtn.prop('disabled', true).find('span.truncate').text('è½¬æ¢ä¸­...');
    
    $.ajax({
        url: '/Tts/ConvertText',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(request),
        success: function(response) {
            console.log('æ”¶åˆ°å“åº”:', response);
            if (response.success) {
                currentAudioData = response.audioData;
                currentSubtitles = response.subtitles;
                console.log('éŸ³é¢‘æ•°æ®é•¿åº¦:', currentAudioData ? currentAudioData.length : 0);
                console.log('å­—å¹•æ•°æ®é•¿åº¦:', currentSubtitles ? currentSubtitles.length : 0);
                console.log('å­—å¹•æ•°æ®:', currentSubtitles);
                
                // æ˜¾ç¤ºå…ƒæ•°æ®ä¿¡æ¯
                if (response.chunkCount || response.processingTimeMs || response.isPreview) {
                    let metaInfo = [];
                    if (response.isPreview) metaInfo.push('ğŸ§ è¯•å¬æ¨¡å¼');
                    if (response.chunkCount > 1) metaInfo.push(`ğŸ“„ ${response.chunkCount} ä¸ªç‰‡æ®µ`);
                    if (response.totalCharacters) metaInfo.push(`ğŸ“ ${response.totalCharacters} å­—ç¬¦`);
                    if (response.processingTimeMs) metaInfo.push(`â±ï¸ ${(response.processingTimeMs / 1000).toFixed(1)}ç§’`);
                    
                    if (metaInfo.length > 0) {
                        console.log('å¤„ç†ä¿¡æ¯:', metaInfo.join(' | '));
                        // å¯ä»¥åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºè¿™äº›ä¿¡æ¯
                    }
                }
                
                $('#inlinePlayer').show();
                
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = 'data:audio/mpeg;base64,' + currentAudioData;
                audioPlayer.onerror = function(e) {
                    console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
                    alert('éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
                };
                audioPlayer.onloadedmetadata = function() {
                    console.log('éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œæ—¶é•¿:', audioPlayer.duration);
                    updateTimeDisplay();
                };
                audioPlayer.load();
                
                if (currentSubtitles) {
                    $('#subtitlesContainer').show();
                    $('#subtitlesContent').text(currentSubtitles);
                } else {
                    $('#subtitlesContainer').hide();
                }
            } else {
                alert('è½¬æ¢å¤±è´¥: ' + response.errorMessage);
            }
        },
        error: function(xhr, status, error) {
            console.error('è½¬æ¢è¯·æ±‚å¤±è´¥:', error);
            alert('è½¬æ¢è¯·æ±‚å¤±è´¥');
        },
        complete: function() {
            $convertBtn.prop('disabled', false).find('span.truncate').text('ç”Ÿæˆè¯­éŸ³');
        }
    });
}

function playAudio() {
    const audioPlayer = document.getElementById('audioPlayer');
    const $playBtn = $('#playBtn .material-symbols-outlined');
    if (audioPlayer.paused) {
        audioPlayer.play();
        $playBtn.text('pause');
    } else {
        audioPlayer.pause();
        $playBtn.text('play_arrow');
    }
}

function updateProgress() {
    const audioPlayer = document.getElementById('audioPlayer');
    if (audioPlayer.duration) {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        $('#progressBar').css('width', progress + '%');
        updateTimeDisplay();
    }
}

function updateTimeDisplay() {
    const audioPlayer = document.getElementById('audioPlayer');
    const current = formatTime(audioPlayer.currentTime);
    const duration = formatTime(audioPlayer.duration);
    $('#timeDisplay').text(current + ' / ' + duration);
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
}

function downloadAudio() {
    if (currentAudioData) {
        const a = document.createElement('a');
        a.href = 'data:audio/mpeg;base64,' + currentAudioData;
        a.download = 'tts_audio_' + new Date().getTime() + '.mp3';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
}

function downloadSubtitles() {
    if (currentSubtitles) {
        const a = document.createElement('a');
        a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(currentSubtitles);
        a.download = 'tts_subtitles_' + new Date().getTime() + '.srt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
}
</script>
}